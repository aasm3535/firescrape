<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FireScrape Playground</title>
  <link rel="stylesheet" href="/style.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            border: "hsl(var(--border))",
            input: "hsl(var(--input))",
            ring: "hsl(var(--ring))",
            background: "hsl(var(--background))",
            foreground: "hsl(var(--foreground))",
            primary: {
              DEFAULT: "hsl(var(--primary))",
              foreground: "hsl(var(--primary-foreground))",
            },
            secondary: {
              DEFAULT: "hsl(var(--secondary))",
              foreground: "hsl(var(--secondary-foreground))",
            },
            destructive: {
              DEFAULT: "hsl(var(--destructive))",
              foreground: "hsl(var(--destructive-foreground))",
            },
            muted: {
              DEFAULT: "hsl(var(--muted))",
              foreground: "hsl(var(--muted-foreground))",
            },
            accent: {
              DEFAULT: "hsl(var(--accent))",
              foreground: "hsl(var(--accent-foreground))",
            },
            popover: {
              DEFAULT: "hsl(var(--popover))",
              foreground: "hsl(var(--popover-foreground))",
            },
            card: {
              DEFAULT: "hsl(var(--card))",
              foreground: "hsl(var(--card-foreground))",
            },
          },
          borderRadius: {
            lg: "var(--radius)",
            md: "calc(var(--radius) - 2px)",
            sm: "calc(var(--radius) - 4px)",
          },
        },
      },
    }
  </script>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col bg-background text-foreground antialiased selection:bg-primary selection:text-white">

  <!-- Navbar (Mobile Only) -->
  <header class="md:hidden sticky top-0 z-50 flex h-14 items-center justify-between border-b bg-background px-4">
    <a href="/" class="flex items-center gap-2 font-bold">
      <i data-lucide="flame" class="h-5 w-5 text-primary"></i> FireScrape
    </a>
    <button onclick="toggleTheme()" class="rounded-md p-2 hover:bg-accent">
      <i data-lucide="moon" id="theme-icon-mobile" class="h-5 w-5"></i>
    </button>
  </header>

  <div class="flex flex-1 overflow-hidden">
    <!-- Sidebar -->
    <aside class="hidden md:flex w-64 flex-col border-r bg-muted/30">
      <div class="flex h-14 items-center border-b px-6">
        <a href="/" class="flex items-center gap-2 font-bold">
          <i data-lucide="flame" class="h-5 w-5 text-primary"></i> FireScrape
        </a>
      </div>
      <div class="flex-1 overflow-auto py-4">
        <nav class="grid items-start px-4 text-sm font-medium gap-2">
          
          <div class="text-muted-foreground text-xs uppercase font-bold tracking-wider mb-1 px-2" data-i18n="lbl_mode">Mode</div>
          <button onclick="setMode('scrape')" id="nav-scrape" class="group flex items-center gap-3 rounded-md px-3 py-2 hover:bg-accent hover:text-accent-foreground text-foreground bg-accent">
            <i data-lucide="globe" class="h-4 w-4"></i> <span data-i18n="mode_scrape">Scrape URL</span>
          </button>
          <button onclick="setMode('search')" id="nav-search" class="group flex items-center gap-3 rounded-md px-3 py-2 text-muted-foreground hover:bg-accent hover:text-accent-foreground transition-all">
            <i data-lucide="search" class="h-4 w-4"></i> <span data-i18n="mode_search">Web Search</span>
          </button>

          <div class="text-muted-foreground text-xs uppercase font-bold tracking-wider mb-1 mt-6 px-2" data-i18n="lbl_settings">Settings</div>
          <div class="px-2">
            <select onchange="changeLang(this.value)" id="langSwitcher" class="w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
              <option value="en">English</option>
              <option value="ru">Русский</option>
              <option value="es">Español</option>
              <option value="zh">中文</option>
            </select>
          </div>
          <button onclick="toggleTheme()" class="group flex items-center gap-3 rounded-md px-3 py-2 text-muted-foreground hover:bg-accent hover:text-accent-foreground mt-1">
            <i data-lucide="moon" id="theme-icon-desktop" class="h-4 w-4"></i> <span data-i18n="lbl_theme">Toggle Theme</span>
          </button>

          <div class="text-muted-foreground text-xs uppercase font-bold tracking-wider mb-1 mt-6 px-2" data-i18n="lbl_history">History</div>
          <div id="history-list" class="flex flex-col gap-1"></div>
        </nav>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col overflow-hidden bg-background">
      <div class="h-14 flex items-center border-b px-4 md:px-6">
        <h1 class="font-semibold text-lg md:text-xl" id="page-title">Playground</h1>
        <div class="ml-auto flex items-center gap-2">
            <span id="status-badge" class="hidden items-center rounded-full border border-transparent bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-300 px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2">200 OK</span>
        </div>
      </div>

      <div class="flex-1 flex flex-col p-4 md:p-6 gap-4 overflow-hidden">
        <!-- Input -->
        <div class="flex w-full items-center space-x-2">
          <input type="text" id="inputField" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50" placeholder="https://example.com" onkeydown="if(event.key==='Enter') executeApi()">
          <button class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2" onclick="executeApi()">
            <i data-lucide="play" class="h-4 w-4 md:mr-2"></i> <span class="hidden md:inline">Run</span>
          </button>
        </div>

        <!-- Output Tabs -->
        <div class="flex-1 flex flex-col rounded-xl border bg-card text-card-foreground shadow overflow-hidden">
          <div class="flex items-center p-2 border-b bg-muted/40">
            <div class="flex space-x-1 rounded-lg bg-muted p-1">
                <button onclick="showTab('json')" class="tab-trigger inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 bg-background text-foreground shadow-sm" id="tab-json">JSON</button>
                <button onclick="showTab('preview')" class="tab-trigger inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 text-muted-foreground hover:bg-background/50" id="tab-preview">Preview</button>
            </div>
          </div>
          
          <div class="flex-1 overflow-auto bg-background relative" id="view-json">
             <pre class="p-4 text-xs md:text-sm font-mono leading-relaxed h-full w-full bg-transparent">Waiting for input...</pre>
          </div>
          <div class="hidden flex-1 overflow-auto p-4 text-sm font-mono whitespace-pre-wrap leading-relaxed" id="view-preview"></div>
        </div>
      </div>
    </main>
  </div>

  <script>
    lucide.createIcons();
    let currentMode = 'scrape';
    const placeholders = ["https://github.com/bunland/bun", "https://example.com"];

    const i18n = {
      en: { lbl_mode: "Mode", mode_scrape: "Scrape URL", mode_search: "Web Search", lbl_settings: "Settings", lbl_history: "History", lbl_theme: "Theme" },
      ru: { lbl_mode: "Режим", mode_scrape: "Парсинг URL", mode_search: "Поиск", lbl_settings: "Настройки", lbl_history: "История", lbl_theme: "Тема" },
      es: { lbl_mode: "Modo", mode_scrape: "Raspar URL", mode_search: "Buscar", lbl_settings: "Ajustes", lbl_history: "Historia", lbl_theme: "Tema" },
      zh: { lbl_mode: "模式", mode_scrape: "抓取网址", mode_search: "搜索", lbl_settings: "设置", lbl_history: "历史", lbl_theme: "主题" }
    };

    function setMode(mode) {
      currentMode = mode;
      document.querySelectorAll('#nav-scrape, #nav-search').forEach(el => {
        el.classList.remove('bg-accent', 'text-foreground');
        el.classList.add('text-muted-foreground', 'hover:bg-accent');
      });
      const active = document.getElementById('nav-' + mode);
      active.classList.remove('text-muted-foreground');
      active.classList.add('bg-accent', 'text-foreground');
      
      const input = document.getElementById('inputField');
      if (mode === 'scrape') input.placeholder = placeholders[Math.floor(Math.random() * placeholders.length)];
      else input.placeholder = "iphone 15 pro max";
    }

    function changeLang(lang) {
      const t = i18n[lang] || i18n['en'];
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (t[key]) el.innerHTML = t[key];
      });
      localStorage.setItem('lang', lang);
      document.getElementById('langSwitcher').value = lang;
    }

    function showTab(tab) {
      document.querySelectorAll('.tab-trigger').forEach(t => {
        t.classList.remove('bg-background', 'text-foreground', 'shadow-sm');
        t.classList.add('text-muted-foreground');
      });
      const active = document.getElementById('tab-' + tab);
      active.classList.add('bg-background', 'text-foreground', 'shadow-sm');
      active.classList.remove('text-muted-foreground');

      if (tab === 'json') {
        document.getElementById('view-json').classList.remove('hidden');
        document.getElementById('view-preview').classList.add('hidden');
      } else {
        document.getElementById('view-json').classList.add('hidden');
        document.getElementById('view-preview').classList.remove('hidden');
      }
    }

    function addToHistory(mode, query) {
        const hist = JSON.parse(localStorage.getItem('fireHistory') || '[]');
        const newHist = [{mode, query}, ...hist.filter(h => h.query !== query)].slice(0, 8);
        localStorage.setItem('fireHistory', JSON.stringify(newHist));
        renderHistory();
    }

    function renderHistory() {
        const list = document.getElementById('history-list');
        list.innerHTML = '';
        JSON.parse(localStorage.getItem('fireHistory') || '[]').forEach(item => {
            const btn = document.createElement('button');
            btn.className = "flex w-full items-center gap-2 rounded-md px-2 py-1.5 text-xs text-muted-foreground hover:bg-accent hover:text-accent-foreground truncate";
            btn.innerHTML = `<i data-lucide="${item.mode === 'scrape'?'globe':'search'}" class="h-3 w-3 shrink-0"></i> <span class="truncate">${item.query}</span>`;
            btn.onclick = () => { setMode(item.mode); document.getElementById('inputField').value = item.query; executeApi(); };
            list.appendChild(btn);
        });
        lucide.createIcons();
    }

    function syntaxHighlight(json) {
      if (typeof json != 'string') json = JSON.stringify(json, undefined, 2);
      json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      return json.replace(/("(\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
        var cls = 'number';
        if (/^"/.test(match)) {
            if (/:$/.test(match)) cls = 'key';
            else cls = 'string';
        } else if (/true|false/.test(match)) cls = 'boolean';
        else if (/null/.test(match)) cls = 'null';
        return '<span class="' + cls + '">' + match + '</span>';
      });
    }

    async function executeApi() {
      const input = document.getElementById('inputField').value;
      if (!input) return;
      
      addToHistory(currentMode, input);
      const pre = document.querySelector('#view-json pre');
      pre.innerHTML = '<span class="text-muted-foreground animate-pulse">Processing...</span>';
      
      try {
        const endpoint = currentMode === 'scrape' ? `/api/scrape?url=${encodeURIComponent(input)}` : `/api/search?q=${encodeURIComponent(input)}`;
        const res = await fetch(endpoint);
        const data = await res.json();
        
        const badge = document.getElementById('status-badge');
        badge.classList.remove('hidden');
        badge.innerText = `${res.status} ${res.statusText}`;
        badge.className = `inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 ${res.ok ? 'border-transparent bg-green-500/15 text-green-700 dark:text-green-400' : 'border-transparent bg-red-500/15 text-red-700 dark:text-red-400'}`;

        pre.innerHTML = syntaxHighlight(data);
        const previewText = (data.data && data.data.content_preview) ? data.data.content_preview : (data.results ? data.results.map(r=>`• ${r.title}
  ${r.link}`).join('

') : 'No preview');
        document.getElementById('view-preview').innerText = previewText;
      } catch (e) {
        pre.innerText = "Error: " + e.message;
      }
    }

    function toggleTheme() {
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        updateThemeIcon();
    }
    function updateThemeIcon() {
        const isDark = document.documentElement.classList.contains('dark');
        const icon = isDark ? 'sun' : 'moon';
        if(document.getElementById('theme-icon-desktop')) document.getElementById('theme-icon-desktop').setAttribute('data-lucide', icon);
        if(document.getElementById('theme-icon-mobile')) document.getElementById('theme-icon-mobile').setAttribute('data-lucide', icon);
        lucide.createIcons();
    }

    const savedTheme = localStorage.getItem('theme');
    const sysDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (savedTheme === 'dark' || (!savedTheme && sysDark)) document.documentElement.classList.add('dark');
    updateThemeIcon();
    
    const savedLang = localStorage.getItem('lang') || 'en';
    if (i18n[savedLang]) changeLang(savedLang);

    setMode('scrape');
    renderHistory();
  </script>
</body>
</html>