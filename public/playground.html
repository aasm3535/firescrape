<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FireScrape Playground</title>
  <link rel="stylesheet" href="/style.css">
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="light flex flex-col h-screen overflow-hidden">

  <!-- Mobile Header (Visible only on mobile for brand/toggle) -->
  <div class="navbar bordered md:hidden shrink-0">
    <a href="/" class="logo">
      <i data-lucide="flame" class="key"></i> FireScrape
    </a>
    <button onclick="toggleTheme()" class="btn btn-ghost p-2">
      <i data-lucide="moon" id="theme-icon-mobile" width="20"></i>
    </button>
  </div>

  <div class="flex flex-1 overflow-hidden">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header hidden md:block">
        <a href="/" class="logo">
          <i data-lucide="flame" class="key"></i> FireScrape
        </a>
      </div>

      <div class="sidebar-content mt-4">
        <div class="nav-group">
          <div class="nav-title" data-i18n="lbl_mode">Mode</div>
          <div class="nav-link active" onclick="setMode('scrape')" id="nav-scrape">
            <i data-lucide="globe" width="16"></i> <span data-i18n="mode_scrape">Scrape URL</span>
          </div>
          <div class="nav-link" onclick="setMode('search')" id="nav-search">
            <i data-lucide="search" width="16"></i> <span data-i18n="mode_search">Web Search</span>
          </div>
        </div>

        <div class="nav-group">
          <div class="nav-title" data-i18n="lbl_settings">Settings</div>
          <div class="px-2 mb-2">
            <select id="langSwitcher" onchange="changeLang(this.value)" class="w-full text-xs h-8">
              <option value="en">English</option>
              <option value="ru">Русский</option>
              <option value="es">Español</option>
              <option value="zh">中文</option>
            </select>
          </div>
          <div class="nav-link hidden md:flex" onclick="toggleTheme()">
            <i data-lucide="moon" id="theme-icon-desktop" width="16"></i> <span data-i18n="lbl_theme">Toggle Theme</span>
          </div>
        </div>

        <div class="nav-group">
          <div class="nav-title" data-i18n="lbl_history">History</div>
          <div id="history-list" class="flex flex-col gap-1 px-1"></div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-auto p-4 md:p-6 bg-secondary/50">
      <div class="container max-w-4xl h-full flex flex-col">
        
        <!-- Input Area -->
        <div class="flex gap-2 mb-4">
          <input type="text" id="inputField" class="flex-1" placeholder="https://example.com" onkeydown="if(event.key==='Enter') executeApi()">
          <button class="btn btn-primary" onclick="executeApi()">
            <i data-lucide="play" width="18" class="mr-2"></i> <span class="hidden-xs">Run</span>
          </button>
        </div>

        <!-- Output Area -->
        <div class="card flex-1 flex flex-col p-0 overflow-hidden bg-background">
          <div class="flex items-center justify-between p-2 border-b border-border bg-muted/50">
            <div class="tabs-list">
              <button class="tab-trigger active" onclick="showTab('json')">JSON</button>
              <button class="tab-trigger" onclick="showTab('preview')">Preview</button>
            </div>
            <span id="status-badge" class="badge badge-success hidden">200 OK</span>
          </div>
          
          <div id="view-json" class="flex-1 overflow-auto p-0 relative">
            <pre class="border-none rounded-none m-0 h-full bg-background text-xs md:text-sm">Waiting for request...</pre>
          </div>
          
          <div id="view-preview" class="hidden flex-1 overflow-auto p-4 font-mono text-sm whitespace-pre-wrap"></div>
        </div>
      </div>
    </main>
  </div>

  <script>
    lucide.createIcons();
    
    // --- State ---
    let currentMode = 'scrape';
    const placeholders = [
      "https://www.wildberries.ru/catalog/211688639/detail.aspx",
      "https://github.com/bunland/bun",
      "https://ozon.ru/product/12345678",
      "https://example.com"
    ];

    // --- I18n ---
    const i18n = {
      en: { 
        lbl_mode: "Mode", mode_scrape: "Scrape URL", mode_search: "Web Search", 
        lbl_settings: "Settings", lbl_history: "History", lbl_theme: "Toggle Theme"
      },
      ru: { 
        lbl_mode: "Режим", mode_scrape: "Парсинг URL", mode_search: "Поиск", 
        lbl_settings: "Настройки", lbl_history: "История", lbl_theme: "Тема"
      },
      es: { 
        lbl_mode: "Modo", mode_scrape: "Raspar URL", mode_search: "Buscar", 
        lbl_settings: "Ajustes", lbl_history: "Historia", lbl_theme: "Tema"
      },
      zh: { 
        lbl_mode: "模式", mode_scrape: "抓取网址", mode_search: "搜索", 
        lbl_settings: "设置", lbl_history: "历史", lbl_theme: "主题"
      }
    };

    function changeLang(lang) {
      const t = i18n[lang] || i18n['en'];
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (t[key]) el.innerHTML = t[key];
      });
      document.getElementById('langSwitcher').value = lang;
      localStorage.setItem('lang', lang);
    }

    // --- Logic ---
    function setMode(mode) {
      currentMode = mode;
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      document.getElementById('nav-' + mode).classList.add('active');
      
      const input = document.getElementById('inputField');
      if (mode === 'scrape') {
        input.placeholder = placeholders[Math.floor(Math.random() * placeholders.length)];
      } else {
        input.placeholder = "iphone 15 pro max";
      }
    }

    function showTab(tab) {
      document.querySelectorAll('.tab-trigger').forEach(t => t.classList.remove('active'));
      Array.from(document.querySelectorAll('.tab-trigger')).find(el => el.innerText.toLowerCase() === tab).classList.add('active');

      if (tab === 'json') {
        document.getElementById('view-json').classList.remove('hidden');
        document.getElementById('view-preview').classList.add('hidden');
      } else {
        document.getElementById('view-json').classList.add('hidden');
        document.getElementById('view-preview').classList.remove('hidden');
      }
    }

    function addToHistory(mode, query) {
      const hist = JSON.parse(localStorage.getItem('fireHistory') || '[]');
      const newHist = [{mode, query}, ...hist.filter(h => h.query !== query)].slice(0, 8);
      localStorage.setItem('fireHistory', JSON.stringify(newHist));
      renderHistory();
    }

    function renderHistory() {
      const list = document.getElementById('history-list');
      const hist = JSON.parse(localStorage.getItem('fireHistory') || '[]');
      list.innerHTML = '';
      hist.forEach(item => {
        const div = document.createElement('div');
        div.className = "nav-link text-xs truncate";
        div.innerHTML = `<i data-lucide="${item.mode === 'scrape' ? 'globe' : 'search'}" width="12"></i> ${item.query}`;
        div.onclick = () => {
          setMode(item.mode);
          document.getElementById('inputField').value = item.query;
          executeApi();
        };
        list.appendChild(div);
      });
      lucide.createIcons();
    }

    function syntaxHighlight(json) {
      if (typeof json != 'string') json = JSON.stringify(json, undefined, 2);
      json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      return json.replace(/("(\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
        var cls = 'number';
        if (/^"/.test(match)) {
            if (/:$/.test(match)) cls = 'key';
            else cls = 'string';
        } else if (/true|false/.test(match)) cls = 'boolean';
        else if (/null/.test(match)) cls = 'null';
        return '<span class="' + cls + '">' + match + '</span>';
      });
    }

    async function executeApi() {
      const input = document.getElementById('inputField').value;
      const jsonPre = document.querySelector('#view-json pre');
      const preview = document.getElementById('view-preview');
      const badge = document.getElementById('status-badge');
      
      if (!input) return;

      addToHistory(currentMode, input);
      jsonPre.innerHTML = '<span class="text-muted-foreground p-4">Processing request...</span>';
      badge.classList.add('hidden');

      const endpoint = currentMode === 'scrape' ? `/api/scrape?url=${encodeURIComponent(input)}` : `/api/search?q=${encodeURIComponent(input)}`;

      try {
        const res = await fetch(endpoint);
        const data = await res.json();
        
        badge.classList.remove('hidden');
        badge.innerText = `${res.status} ${res.statusText}`;
        badge.className = res.ok ? 'badge badge-success' : 'badge badge-outline text-destructive border-destructive';

        jsonPre.innerHTML = syntaxHighlight(data);

        if (data.data && data.data.content_preview) preview.innerText = data.data.content_preview;
        else if (data.results) preview.innerText = data.results.map(r => `• ${r.title}\n  ${r.link}`).join('\n\n');
        else preview.innerText = "No text preview available.";

      } catch (err) {
        jsonPre.innerText = err.message;
      }
    }

    // --- Init ---
    // Theme
    function toggleTheme() {
      const isDark = document.body.classList.toggle('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      updateThemeIcon();
    }

    function updateThemeIcon() {
      const isDark = document.body.classList.contains('dark');
      const icon = isDark ? 'sun' : 'moon';
      if(document.getElementById('theme-icon-desktop')) document.getElementById('theme-icon-desktop').setAttribute('data-lucide', icon);
      if(document.getElementById('theme-icon-mobile')) document.getElementById('theme-icon-mobile').setAttribute('data-lucide', icon);
      lucide.createIcons();
    }

    const savedTheme = localStorage.getItem('theme');
    const sysDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (savedTheme === 'dark' || (!savedTheme && sysDark)) {
      document.body.classList.add('dark');
    }
    updateThemeIcon();

    // Lang
    const savedLang = localStorage.getItem('lang') || (navigator.language || 'en').substring(0, 2);
    if(i18n[savedLang]) changeLang(savedLang);

    setMode('scrape');
    renderHistory();
  </script>
</body>
</html>